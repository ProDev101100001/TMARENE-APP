rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * TAMAREENI SECURITY RULES
     *
     * CORE PHILOSOPHY
     * This ruleset enforces a strict user-ownership model. Every piece of sensitive data—including 
     * profiles, daily activity logs, meal tracking, and workout plans—is nested under a 
     * /users/{userId} hierarchy. Access is granted exclusively to the owner identified by the 
     * Firebase Authentication UID.
     *
     * DATA STRUCTURE
     * The database is organized into two primary segments:
     * 1. User-Specific Tree: All personal data is segregated under /users/{userId}/...
     * 2. Global Catalog: Shared reference data, such as the generic exercise library, 
     *    is stored in a top-level /exercises collection.
     *
     * KEY SECURITY DECISIONS
     * - Ownership via Path: Authorization is derived directly from the document path. If a user's 
     *   UID is 'abc', they are authorized for paths starting with /users/abc.
     * - Global Read-Only: The /exercises collection is readable by any authenticated user but 
     *   strictly non-writable by clients to preserve data integrity.
     * - Prototyping Flexibility: While ownership is strictly enforced, these rules do not 
     *   validate full object schemas or data types for general content fields, allowing for 
     *   rapid UI/UX iteration.
     * - Relational Integrity: Critical fields like 'userId' or 'id' are validated upon 
     *   creation and enforced as immutable upon update to prevent data drifting between 
     *   the document content and its secure path.
     */

    // --- GLOBAL HELPER FUNCTIONS ---

    /** @description Checks if the user is authenticated with a valid UID. */
    function isSignedIn() {
      return request.auth != null;
    }

    /** @description Checks if the authenticated user matches the provided userId. */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /** @description Checks if the authenticated user is the owner and the document exists. Used for destructive operations. */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /** @description Validates that the owner field in the data matches the owner in the path. */
    function matchesPathOwner(userId, fieldName) {
      return request.resource.data[fieldName] == userId;
    }

    /** @description Enforces that a specific field cannot be changed after creation. */
    function isFieldImmutable(fieldName) {
      return !(fieldName in request.resource.data) || request.resource.data[fieldName] == resource.data[fieldName];
    }

    // --- COLLECTION RULES ---

    /**
     * @description Global catalog of exercises available to all users.
     * @path /exercises/{exerciseId}
     * @allow (get) Any signed-in user fetching a specific exercise template.
     * @deny (write) Any client attempting to modify the exercise library.
     * @principle Public read (authenticated) with server-side only writes.
     */
    match /exercises/{exerciseId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    match /users/{userId} {
      
      /**
       * @description User profile document storing physical attributes and goals.
       * @path /users/{userId}/profile_data/{docId}
       * @allow (update) The owner updating their BMI or goal.
       * @deny (create) A user attempting to create a profile for a different UID.
       * @principle Path-based ownership with relational integrity check for 'id'.
       */
      match /profile_data/{docId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && request.resource.data.id == userId;
        allow update: if isExistingOwner(userId) && isFieldImmutable('id');
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Daily aggregation of health stats (steps, calories, macros).
       * @path /users/{userId}/dailyLogs/{dailyLogDate}
       * @allow (list) Owner viewing their history of logs.
       * @deny (update) Attempting to change the 'userId' associated with a log.
       * @principle Strict ownership with immutable identity fields.
       */
      match /dailyLogs/{dailyLogDate} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && matchesPathOwner(userId, 'userId');
        allow update: if isExistingOwner(userId) && isFieldImmutable('userId');
        allow delete: if isExistingOwner(userId);

        /**
         * @description Detailed step and distance tracking for the day.
         * @path /users/{userId}/dailyLogs/{dailyLogDate}/stepLog_data/{docId}
         */
        match /stepLog_data/{docId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update, delete: if isExistingOwner(userId);
        }

        /**
         * @description Completion status and duration for the day's workout.
         * @path /users/{userId}/dailyLogs/{dailyLogDate}/workoutLog_data/{docId}
         */
        match /workoutLog_data/{docId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update, delete: if isExistingOwner(userId);
        }

        /**
         * @description Records of individual meals consumed.
         * @path /users/{userId}/dailyLogs/{dailyLogDate}/mealLogs/{mealLogId}
         */
        match /mealLogs/{mealLogId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update, delete: if isExistingOwner(userId);

          /**
           * @description Individual food items identified within a meal.
           * @path /users/{userId}/dailyLogs/{dailyLogDate}/mealLogs/{mealLogId}/foodItemLogs/{foodItemLogId}
           */
          match /foodItemLogs/{foodItemLogId} {
            allow get, list: if isOwner(userId);
            allow create: if isOwner(userId);
            allow update, delete: if isExistingOwner(userId);
          }
        }
      }

      /**
       * @description Personalized multi-day workout program.
       * @path /users/{userId}/workoutPrograms/{programId}
       */
      match /workoutPrograms/{programId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && matchesPathOwner(userId, 'userId');
        allow update: if isExistingOwner(userId) && isFieldImmutable('userId');
        allow delete: if isExistingOwner(userId);

        /**
         * @description Planned exercises for a specific program day.
         */
        match /workoutProgramDays/{programDayId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update, delete: if isExistingOwner(userId);

          /**
           * @description Specific parameters (reps, sets) for an exercise configuration.
           */
          match /programDayExercises/{programDayExerciseId} {
            allow get, list: if isOwner(userId);
            allow create: if isOwner(userId);
            allow update, delete: if isExistingOwner(userId);
          }
        }
      }

      /**
       * @description Weekly weight tracking entries.
       * @path /users/{userId}/weightEntries/{weightEntryId}
       */
      match /weightEntries/{weightEntryId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && matchesPathOwner(userId, 'userId');
        allow update: if isExistingOwner(userId) && isFieldImmutable('userId');
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description History of interactions with the AI Health Assistant.
       * @path /users/{userId}/aiChatInteractions/{chatInteractionId}
       */
      match /aiChatInteractions/{chatInteractionId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId) && matchesPathOwner(userId, 'userId');
        allow update: if isExistingOwner(userId) && isFieldImmutable('userId');
        allow delete: if isExistingOwner(userId);
      }
    }
  }
}